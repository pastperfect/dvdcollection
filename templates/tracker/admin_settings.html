{% extends 'base.html' %}

{% block title %}Admin Settings{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-gear"></i> Admin Settings</h1>
                <p class="text-muted mb-0">Manage application configuration</p>
            </div>
            <a href="{% url 'tracker:home' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Home
            </a>
        </div>

        <!-- TMDB API Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-key"></i> TMDB API Configuration</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="tmdb_api_key" class="form-label">TMDB API Key</label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="tmdb_api_key" 
                                   name="tmdb_api_key" 
                                   value="{{ settings.tmdb_api_key }}"
                                   placeholder="Enter your TMDB API key">
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    onclick="togglePasswordVisibility('tmdb_api_key')">
                                <i class="bi bi-eye" id="tmdb_api_key_icon"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Get your TMDB API key from 
                            <a href="https://www.themoviedb.org/settings/api" target="_blank" class="text-decoration-none">
                                The Movie Database API settings
                            </a>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="bi bi-check-circle"></i> Current Status
                                    </h6>
                                    {% if settings.tmdb_api_key %}
                                        <p class="card-text text-success mb-0">
                                            <i class="bi bi-shield-check"></i> API Key configured
                                        </p>
                                        <small class="text-muted">
                                            Key: ****{{ settings.tmdb_api_key|slice:"-4:" }}
                                        </small>
                                    {% else %}
                                        <p class="card-text text-warning mb-0">
                                            <i class="bi bi-exclamation-triangle"></i> No API Key configured
                                        </p>
                                        <small class="text-muted">
                                            TMDB features will not work without an API key
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <h6 class="card-title text-secondary">
                                        <i class="bi bi-info-circle"></i> Features Enabled
                                    </h6>
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="{% if settings.tmdb_api_key %}text-success{% else %}text-muted{% endif %}">
                                            <i class="bi bi-{% if settings.tmdb_api_key %}check{% else %}x{% endif %}"></i> Movie search & add
                                        </li>
                                        <li class="{% if settings.tmdb_api_key %}text-success{% else %}text-muted{% endif %}">
                                            <i class="bi bi-{% if settings.tmdb_api_key %}check{% else %}x{% endif %}"></i> Automatic metadata
                                        </li>
                                        <li class="{% if settings.tmdb_api_key %}text-success{% else %}text-muted{% endif %}">
                                            <i class="bi bi-{% if settings.tmdb_api_key %}check{% else %}x{% endif %}"></i> Poster management
                                        </li>
                                        <li class="{% if settings.tmdb_api_key %}text-success{% else %}text-muted{% endif %}">
                                            <i class="bi bi-{% if settings.tmdb_api_key %}check{% else %}x{% endif %}"></i> Bulk refresh
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Save Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TMDB Data Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-database"></i> TMDB Data Management</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-warning">
                                    <i class="bi bi-info-circle"></i> Missing Details Detection
                                </h6>
                                <p class="card-text small text-muted">
                                    Some DVDs may be missing detailed information like taglines, budget/revenue data, 
                                    production companies, or director information. This typically happens with older 
                                    bulk uploads that used basic search data.
                                </p>
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> 
                                    The refresh function will identify and update DVDs missing these key details.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-body">
                                <h6 class="card-title text-info">
                                    <i class="bi bi-list-check"></i> Detailed Fields Include
                                </h6>
                                <ul class="list-unstyled mb-0 small">
                                    <li><i class="bi bi-tag"></i> Movie taglines</li>
                                    <li><i class="bi bi-currency-dollar"></i> Budget & revenue data</li>
                                    <li><i class="bi bi-building"></i> Production companies</li>
                                    <li><i class="bi bi-person-video"></i> Director information</li>
                                    <li><i class="bi bi-shield-check"></i> UK certifications</li>
                                    <li><i class="bi bi-star"></i> Enhanced ratings</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TMDB Refresh Actions -->
                <div class="row">
                    <!-- Refresh Missing Details -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-search text-warning"></i> Refresh Missing Details
                                </h6>
                                <p class="card-text small text-muted">
                                    <strong>Recommended:</strong> Efficiently update only DVDs missing detailed information 
                                    like taglines, budget/revenue, production companies, and director data.
                                </p>
                                <button type="button" 
                                        class="btn btn-warning btn-sm" 
                                        onclick="startDetailedRefresh()">
                                    <i class="bi bi-search"></i> Refresh Missing Details
                                </button>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-clock"></i> Variable duration (only missing data)
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Refresh All TMDB -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-arrow-clockwise text-primary"></i> Refresh All TMDB Data
                                </h6>
                                <p class="card-text small text-muted">
                                    Refresh ALL movie data from TMDB for every DVD in your collection. 
                                    This updates everything including basic info and detailed data.
                                </p>
                                <button type="button" 
                                        class="btn btn-primary btn-sm" 
                                        onclick="startFullRefresh()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh All Data
                                </button>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-exclamation-triangle"></i> Longer operation
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Section (Hidden by default) -->
                <div id="tmdb-progress-section" class="alert alert-info mt-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="bi bi-hourglass-split"></i> <span id="progress-title">TMDB Refresh Progress</span>
                        </h6>
                        <button type="button" class="btn-close btn-sm" onclick="hideProgress()"></button>
                    </div>
                    <div class="progress mb-2" style="height: 20px;">
                        <div id="progress-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: 0%">
                            0%
                        </div>
                    </div>
                    <small id="progress-status" class="text-muted">Starting...</small>
                    <div id="progress-results" class="mt-2" style="display: none;">
                        <small class="text-success">
                            <i class="bi bi-check-circle"></i> Updated: <span id="updated-count">0</span>
                        </small>
                        <small class="text-danger ms-3">
                            <i class="bi bi-x-circle"></i> Failed: <span id="failed-count">0</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Torrent Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cloud-download"></i> Torrent Management</h5>
            </div>
            <div class="card-body">
                <!-- Torrent Statistics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-body">
                                <h6 class="card-title text-info">
                                    <i class="bi bi-bar-chart"></i> Torrent Statistics
                                </h6>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="d-flex flex-column">
                                            <span class="h4 text-success mb-0">{{ dvds_with_torrents }}</span>
                                            <small class="text-muted">With Torrents</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex flex-column">
                                            <span class="h4 text-warning mb-0">{{ stale_torrent_data }}</span>
                                            <small class="text-muted">Need Refresh</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ torrent_coverage }}%"
                                         title="{{ torrent_coverage|floatformat:1 }}% coverage">
                                    </div>
                                </div>
                                <small class="text-muted">
                                    Coverage: {{ torrent_coverage|floatformat:1 }}% 
                                    ({{ dvds_with_torrents }} of {{ total_dvds }} total DVDs)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-secondary">
                            <div class="card-body">
                                <h6 class="card-title text-secondary">
                                    <i class="bi bi-info-circle"></i> System Status
                                </h6>
                                <ul class="list-unstyled mb-0 small">
                                    <li class="text-primary">
                                        <i class="bi bi-collection"></i> Total DVDs: {{ total_dvds }}
                                    </li>
                                    <li class="text-info">
                                        <i class="bi bi-film"></i> With IMDB IDs: {{ dvds_with_imdb }}
                                    </li>
                                    <li class="text-success">
                                        <i class="bi bi-check-circle"></i> With torrents: {{ dvds_with_torrents }}
                                    </li>
                                    <li class="text-warning">
                                        <i class="bi bi-clock"></i> Stale data: {{ stale_torrent_data }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Torrent Actions -->
                <div class="row">
                    <!-- Update Flags Only -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-arrow-clockwise text-info"></i> Update Torrent Flags
                                </h6>
                                <p class="card-text small text-muted">
                                    Quickly update torrent availability flags based on existing cached data. 
                                    This operation is fast and doesn't make any API calls.
                                </p>
                                <form method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" name="refresh_flags" class="btn btn-info btn-sm">
                                        <i class="bi bi-arrow-clockwise"></i> Update Flags
                                    </button>
                                </form>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-lightning"></i> Instant operation
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Refresh Small Batch -->
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-cloud-download text-primary"></i> Refresh Sample
                                </h6>
                                <p class="card-text small text-muted">
                                    Refresh torrent data for a small batch (10 DVDs) with stale data. 
                                    Good for testing and immediate feedback.
                                </p>
                                <form method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" name="refresh_small_batch" class="btn btn-primary btn-sm">
                                        <i class="bi bi-cloud-download"></i> Refresh 10 DVDs
                                    </button>
                                </form>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-clock"></i> ~15 seconds
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Command Line Instructions -->
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="bi bi-terminal"></i> Bulk Operations
                    </h6>
                    <p class="mb-2">For refreshing large numbers of DVDs, use the command line interface:</p>
                    <div class="bg-dark text-light p-2 rounded">
                        <code class="text-light">
                            # Update flags only (instant)<br>
                            python manage.py refresh_torrent_data --update-flags-only<br><br>
                            # Refresh 50 DVDs with stale data<br>
                            python manage.py refresh_torrent_data --batch-size=50<br><br>
                            # Force refresh all DVDs (use with caution)<br>
                            python manage.py refresh_torrent_data --force --batch-size=100
                        </code>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-exclamation-triangle"></i>
                        Large batch operations may take several minutes and should be run during off-peak hours.
                    </small>
                </div>
            </div>
        </div>

        <!-- UK Certification Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> UK Certification Management</h5>
            </div>
            <div class="card-body">
                <!-- Certification Statistics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-body">
                                <h6 class="card-title text-info">
                                    <i class="bi bi-bar-chart"></i> Certification Statistics
                                </h6>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="d-flex flex-column">
                                            <span class="h4 text-success mb-0">{{ dvds_with_certifications }}</span>
                                            <small class="text-muted">With Certifications</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex flex-column">
                                            <span class="h4 {% if certifications_needing_update > 0 %}text-warning{% else %}text-success{% endif %} mb-0">{{ certifications_needing_update }}</span>
                                            <small class="text-muted">Need Normalization</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ certification_normalized_percentage|floatformat:0 }}%"
                                         title="{{ certification_normalized_percentage|floatformat:1 }}% normalized">
                                    </div>
                                </div>
                                <small class="text-muted">
                                    {% if dvds_with_certifications > 0 %}
                                        Normalized: {{ certification_normalized_percentage|floatformat:1 }}% 
                                        ({{ certifications_normalized }} of {{ dvds_with_certifications }} total)
                                    {% else %}
                                        No certifications found
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-secondary">
                            <div class="card-body">
                                <h6 class="card-title text-secondary">
                                    <i class="bi bi-info-circle"></i> Normalization Info
                                </h6>
                                <p class="card-text small text-muted mb-3">
                                    UK certifications should be in lowercase for consistency. 
                                    Examples: "pg", "12a", "15", "18", "u"
                                </p>
                                <ul class="list-unstyled mb-0 small">
                                    <li class="text-info">
                                        <i class="bi bi-check-circle"></i> Ensures data consistency
                                    </li>
                                    <li class="text-info">
                                        <i class="bi bi-search"></i> Improves filtering accuracy
                                    </li>
                                    <li class="text-info">
                                        <i class="bi bi-sort-alpha-down"></i> Better sorting results
                                    </li>
                                    <li class="text-info">
                                        <i class="bi bi-database"></i> Database optimization
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Certification Actions -->
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-2">Normalize UK Certifications</h6>
                        <p class="text-muted mb-0">
                            Convert all UK certification values to lowercase for consistency and better data management.
                            This operation will update certifications like "PG" → "pg", "12A" → "12a", etc.
                        </p>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            {% if certifications_needing_update > 0 %}
                                Will update {{ certifications_needing_update }} certification{{ certifications_needing_update|pluralize }} that need normalization.
                            {% else %}
                                All certifications are already normalized.
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-end">
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" 
                                    name="normalize_certifications" 
                                    class="btn {% if certifications_needing_update > 0 %}btn-warning{% else %}btn-outline-success{% endif %} btn-sm"
                                    {% if certifications_needing_update == 0 %}disabled{% endif %}>
                                <i class="bi bi-check2-square"></i> 
                                {% if certifications_needing_update > 0 %}
                                    Normalize ({{ certifications_needing_update }})
                                {% else %}
                                    Already Normalized
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Command Line Instructions -->
                {% if certifications_needing_update > 0 %}
                <div class="alert alert-info mt-3">
                    <h6 class="alert-heading">
                        <i class="bi bi-terminal"></i> Command Line Alternative
                    </h6>
                    <p class="mb-2">You can also run this operation from the command line:</p>
                    <div class="bg-dark text-light p-2 rounded">
                        <code class="text-light">
                            # Preview what will be updated (dry run)<br>
                            python manage.py normalize_uk_certifications --dry-run<br><br>
                            # Perform the actual update<br>
                            python manage.py normalize_uk_certifications --verbose
                        </code>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i>
                        Use --dry-run to preview changes before applying them.
                    </small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Export Functions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-download"></i> Export Functions</h5>
            </div>
            <div class="card-body">
                <!-- Non-Kept DVDs Export -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h6 class="mb-2">Export Non-Kept DVDs</h6>
                        <p class="text-muted mb-0">
                            Export all DVDs that are not marked as "Kept" to a CSV file. 
                            Includes movie details and download links (720p and 1080p) where available.
                        </p>
                    </br>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Exports: Movie Name, Release Year, Status, Media Type, and Torrent Download Links
                        </small>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-end">
                        <a href="{% url 'tracker:export_non_kept_dvds' %}" class="btn btn-outline-success">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export Non-Kept
                        </a>
                    </div>
                </div>
                
                <hr>
                
                <!-- Disposed DVDs Export -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h6 class="mb-2">Export Disposed DVDs for Download</h6>
                        <p class="text-muted mb-0">
                            Export disposed DVDs (excluding already downloaded) with torrent download links. 
                            Perfect for finding movies to download that you've previously disposed of.
                        </p>
                    </br>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Exports: Movie Name, Status, 720p Torrent Link, 1080p Torrent Link
                            <br>
                            <i class="bi bi-filter"></i>
                            Filters: Status = Disposed AND Media Type ≠ Downloaded
                        </small>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-end">
                        <a href="{% url 'tracker:export_disposed_for_download' %}" class="btn btn-outline-warning">
                            <i class="bi bi-cloud-download"></i> Export Disposed
                        </a>
                    </div>
                </div>
                
                <hr>
                
                <!-- Complete Collection Export -->
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-2">Export Complete Collection</h6>
                        <p class="text-muted mb-2">
                            Export your entire DVD collection with comprehensive details to a CSV file.
                        </p>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Includes: Movie Name, Status, Release Year, Runtime, Tartan Release, Media Type, 
                            Box Set info, Storage/Location details, Dates, Torrent Links, Director, and more
                        </small>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-end">
                        <a href="{% url 'tracker:export_complete_collection' %}" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet-fill"></i> Export Complete
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Future Settings Sections -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Additional Settings</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">
                    <i class="bi bi-construction"></i>
                    More configuration options will be added here in future updates.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

// TMDB Refresh Functions
let refreshIntervalId = null;

function startDetailedRefresh() {
    if (!confirm('This will refresh detailed TMDB data for DVDs missing information like taglines, budget/revenue, and production companies. Continue?')) {
        return;
    }
    
    document.getElementById('progress-title').textContent = 'Missing Details Refresh Progress';
    startRefresh('{% url "tracker:refresh_missing_details" %}', 'details');
}

function startFullRefresh() {
    if (!confirm('This will refresh ALL TMDB data for every DVD in your collection. This may take a while. Continue?')) {
        return;
    }
    
    document.getElementById('progress-title').textContent = 'Full TMDB Refresh Progress';
    startRefresh('{% url "tracker:refresh_all_tmdb" %}', 'full');
}

function startRefresh(url, type) {
    // Show progress section
    document.getElementById('tmdb-progress-section').style.display = 'block';
    
    // Reset progress
    updateProgress(0, 'Starting refresh...', false, {updated: 0, failed: 0});
    
    // Start the refresh
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Start polling for progress
            pollProgress(data.task_id, type);
        } else {
            updateProgress(0, 'Error starting refresh: ' + (data.error || 'Unknown error'), true, {updated: 0, failed: 0});
        }
    })
    .catch(error => {
        updateProgress(0, 'Network error: ' + error.message, true, {updated: 0, failed: 0});
    });
}

function pollProgress(taskId, type) {
    const progressUrl = '{% url "tracker:refresh_progress" %}?task_id=' + taskId + '&type=' + type;
    
    refreshIntervalId = setInterval(() => {
        fetch(progressUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success !== false) {
                updateProgress(
                    Math.round(data.progress || 0), 
                    data.status || 'Processing...', 
                    data.completed || false,
                    data.results || {updated: 0, failed: 0}
                );
                
                if (data.completed) {
                    clearInterval(refreshIntervalId);
                    refreshIntervalId = null;
                }
            } else {
                updateProgress(0, 'Error checking progress: ' + (data.error || 'Unknown error'), true, {updated: 0, failed: 0});
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        })
        .catch(error => {
            updateProgress(0, 'Network error: ' + error.message, true, {updated: 0, failed: 0});
            clearInterval(refreshIntervalId);
            refreshIntervalId = null;
        });
    }, 2000); // Poll every 2 seconds
}

function updateProgress(percentage, status, completed, results) {
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const progressResults = document.getElementById('progress-results');
    const updatedCount = document.getElementById('updated-count');
    const failedCount = document.getElementById('failed-count');
    
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
    progressStatus.textContent = status;
    
    if (completed) {
        progressBar.classList.remove('progress-bar-animated');
        if (results.updated > 0) {
            progressBar.classList.remove('bg-primary');
            progressBar.classList.add('bg-success');
        }
    }
    
    if (results) {
        updatedCount.textContent = results.updated || 0;
        failedCount.textContent = results.failed || 0;
        progressResults.style.display = 'block';
    }
}

function hideProgress() {
    document.getElementById('tmdb-progress-section').style.display = 'none';
    if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
    }
}
</script>
{% endblock %}
